var Graph=function(t,i){this.canvas=t,this.dataset=i,this.points=[],this.position={x:0,y:0},this.highlight="",this.point={},this.ratio=1,this.realWidth,this.init(),this.listen()};Graph.prototype.init=function(){this.canvas.getContext("2d");this.makeHighRes()},Graph.prototype.listen=function(){var t=this;this.canvas.addEventListener("mousemove",function(i){t.position=t.getMousePos(i),t.draw()},!1),this.canvas.addEventListener("touchmove",function(i){t.position=t.getMousePos(i),t.draw()},!1),this.canvas.addEventListener("touchstart",function(i){t.position=t.getMousePos(i),t.draw()},!1)},Graph.prototype.makeHighRes=function(){var t=this.canvas.getContext("2d"),i=window.devicePixelRatio||1,e=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,h=i/e;if(i!==e){var a=this.canvas.width,s=this.canvas.height;this.canvas.width=Math.round(a*h),this.canvas.height=Math.round(s*h),this.canvas.style.width=a+"px",this.canvas.style.height=s+"px",t.save(),t.scale(h,h),this.ratio=h,t.restore()}},Graph.prototype.getMousePos=function(t){t.preventDefault();var i=this.canvas.getBoundingClientRect();return window.event.touches?{x:(window.event.touches[0].pageX-i.left)*this.ratio,y:(window.event.touches[0].pageY-i.top)*this.ratio}:{x:(t.clientX-i.left)*this.ratio,y:(t.clientY-i.top)*this.ratio}},Graph.prototype.getHistory=function(){var t=1,i=new Date,e=new Date;e.setDate(e.getDate()-7);var h=new Date;h.setMonth(h.getMonth()-1);var a=new Date;a.setMonth(a.getMonth()-3);var s=new Date;s.setMonth(s.getMonth()-6);var o=i.getFullYear()+"-"+("0"+(i.getMonth()+1)).slice(-2)+"-"+i.getDate(),r=i.getFullYear()-1+"-"+("0"+(i.getMonth()+1)).slice(-2)+"-"+i.getDate(),n=h.getFullYear()+"-"+("0"+(h.getMonth()+1)).slice(-2)+"-"+h.getDate(),g=a.getFullYear()+"-"+("0"+(a.getMonth()+1)).slice(-2)+"-"+a.getDate(),p=s.getFullYear()+"-"+("0"+(s.getMonth()+1)).slice(-2)+"-"+s.getDate(),l=(e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate(),"");if("week"==this.time)t=7;else if("month"==this.time)var l=n;else if("3month"==this.time)var l=g;else if("6month"==this.time)var l=p;else if("year"==this.time)var l=r;if("day"==this.time||"week"==this.time){var c=this;window.finance_charts_json_callback=function(t){t.series.forEach(function(t,i){c.graph.history.push(parseFloat(t.close))}),c.graph.previousClose=t.meta.previous_close,c.graph.max=Math.max.apply(Math,c.graph.history),c.graph.min=Math.min.apply(Math,c.graph.history),c.realWidth=c.canvas.width*c.ratio-12*(c.graph.max.toFixed(2).toString().length+1)*c.ratio,c.graph.history.forEach(function(t,i){c.graph.points.push((t-c.graph.min)/(c.graph.max-c.graph.min)*(c.canvas.height-c.canvas.height/10-c.canvas.height/10)+c.canvas.height/10)}),c.graph.previousPoint=(t.meta.previous_close-c.graph.min)/(c.graph.max-c.graph.min)*(c.canvas.height-c.canvas.height/10-c.canvas.height/10)+c.canvas.height/10,c.draw()};var d=document.createElement("script");d.setAttribute("src","http://chartapi.finance.yahoo.com/instrument/1.1/"+this.symbol+"/chartdata;type=close;range="+t+"d/json/"),document.body.appendChild(d)}else{var c=this;this.getJson("https://query.yahooapis.com/v1/public/yql?q=select%20Close%20from%20yahoo.finance.historicaldata%20where%20symbol%20%3D%20%22"+this.ticker+"%22%20and%20startDate%20%3D%20%22"+l+"%22%20and%20endDate%20%3D%20%22"+o+"%22%0A&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=",function(t){t.query.results.quote.forEach(function(t,i){c.graph.history.push(t.Close)}),c.graph.max=Math.max.apply(Math,c.graph.history),c.graph.min=Math.min.apply(Math,c.graph.history),c.realWidth=c.canvas.width*c.ratio-12*(c.graph.max.toFixed(2).toString().length+1)*c.ratio,c.graph.history.forEach(function(t,i){c.graph.points.push((t-c.graph.min)/(c.graph.max-c.graph.min)*(c.canvas.height-c.canvas.height/10-c.canvas.height/10)+c.canvas.height/10)}),c.draw()})}},Graph.prototype.draw=function(t){var i=this.canvas,e=i.getContext("2d");if("day"==this.time||"week"==this.time)var h=0;else var h=this.realWidth;if("day"==this.time)var a=this.realWidth/390;else var a=this.realWidth/this.graph.points.length;e.clearRect(0,0,i.width,i.height),e.fillStyle="#FFF",e.fillRect(0,0,i.width,i.height),e.fillStyle="#FFF",e.beginPath(),e.save(),"day"==this.time||"week"==this.time?(e.moveTo(0,i.height-this.graph.previousPoint),e.lineTo(this.realWidth,i.height-this.graph.previousPoint),e.strokeStyle="#9E9E9E",e.lineWidth=2*this.ratio,e.setLineDash([5*this.ratio]),e.stroke(),e.restore(),e.beginPath()):(e.moveTo(this.realWidth,i.height-this.graph.points[this.graph.points.length-1]),e.lineTo(0,i.height-this.graph.points[this.graph.points.length-1]),e.strokeStyle="#212121",e.lineWidth=2*this.ratio,e.setLineDash([5*this.ratio]),e.stroke(),e.restore(),e.beginPath());var s=this;this.graph.points.forEach(function(t,o){s.highlight==o&&(s.point={x:h,y:s.canvas.height-t}),"day"==s.time||"week"==s.time?(e.lineTo(h,s.canvas.height-t),h+=a):(e.lineTo(h,i.height-t),h-=a)}),"day"==this.time||"week"==this.time?this.graph.previousPoint<this.graph.points[this.graph.points.length-1]?(e.strokeStyle="#00C853",e.fillStyle="#00C853"):this.graph.previousPoint>this.graph.points[this.graph.points.length-1]&&(e.strokeStyle="#F44336",e.fillStyle="#F44336"):this.graph.points[0]>this.graph.points[this.graph.points.length-1]?(e.strokeStyle="#00C853",e.fillStyle="#00C853"):this.graph.points[0]<this.graph.points[this.graph.points.length-1]&&(e.strokeStyle="#F44336",e.fillStyle="#F44336"),e.lineWidth=2*this.ratio,e.stroke(),e.restore(),this.point&&(e.beginPath(),e.save(),e.arc(this.point.x,this.point.y,5*this.ratio,0,2*Math.PI,!1),e.shadowColor="#777",e.shadowBlur=10*this.ratio,e.fill(),e.stroke(),e.restore()),e.beginPath(),e.save();var o=0,r=Math.round(i.height/8);for(o+=r;o<=i.height-i.height/10;){var n=(o-i.height/10)/(i.height-i.height/10)*(this.graph.max-this.graph.min)+this.graph.min;n=parseFloat(n),e.font=15*this.ratio+"px Arial",e.fillStyle="#212121";var g=n.toFixed(2).toString().length,p=12*this.ratio;e.fillText("$"+n.toFixed(2),i.width-g*p,i.height-o),o+=r}if(e.stroke(),e.restore(),this.position.x){if("week"==this.time){var l=this.graph.history[Math.round(this.position.x/(this.realWidth/this.graph.history.length))];this.highlight=Math.round(this.position.x/(this.realWidth/this.graph.history.length))-1}else if("day"==this.time){var l=this.graph.history[Math.round(this.position.x/(this.realWidth/390))];this.highlight=Math.round(this.position.x/(this.realWidth/390))-1}else{var l=this.graph.history[this.graph.history.length-Math.round(this.position.x/(this.realWidth/this.graph.history.length))];this.highlight=this.graph.history.length-Math.round(this.position.x/(this.realWidth/this.graph.history.length))}l&&(this.display=parseFloat(l),this.display=this.display.toFixed(2)),e.beginPath(),e.save(),e.moveTo(this.position.x,i.height),e.lineTo(this.position.x,0),e.strokeStyle="#212121",e.lineWidth=1,e.stroke(),e.restore()}},Graph.prototype.getJson=function(t,i){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var t=JSON.parse(e.responseText);return i(t)}},e.open("GET",t,!0),e.send()},Graph.prototype.getJsonp=function(t,i){var e=document.createElement("script");e.src=t,document.getElementByTagName("head")[0].appendChild(e)};